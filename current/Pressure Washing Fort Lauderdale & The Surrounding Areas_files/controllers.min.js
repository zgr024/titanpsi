"use strict";function sanitizeHtml(strCode){if("undefined"!=typeof strCode&&null!==strCode&&strCode.length>0){var html=strCode.replace(/<\/?[^>]+(>|$)/g,"");return html.length!==strCode.length,0==strCode.indexOf("<a href")?strCode:html}return strCode}function replaceURLWithHTMLLinks(text){var exp=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/i;return text.replace(exp,"<a href='$1' target='_blank'>$1</a>")}function stripScripts(s){var div=document.createElement("div");div.innerHTML=s;for(var scripts=div.getElementsByTagName("script"),i=scripts.length;i--;)scripts[i].parentNode.removeChild(scripts[i]);return div.innerHTML}function onInit(){var mics=eval($("#flash")[0].micList()),sources=$("#input_source"),current_mic=$("#flash")[0].getMic();for(sources.children().remove(),$("#status").text("Connecting..."),i=0;i<mics.length;i++){var a=i==current_mic?"selected":"";sources.append("<option value='"+i+"' "+a+" >"+mics[i]+"</option>")}}function onConnected(sessionid){$("#sessionid").text(sessionid),$(".call","#call_container").remove(),$(".account","#account_container").remove(),$("#status").text("Connected")}function onCallState(uuid,state){$("#call_"+uuid).children(".call_state").text(state)}function checkMic(){try{return $("#flash")[0].isMuted()?($("#no_mic").show(),$("#input_source").hide(),!1):($("#no_mic").hide(),$("#input_source").show(),!0)}catch(err){return!1}}function onDebug(message){"-1"!=message.indexOf("code=")&&("Microphone.Unmuted"==message.substring(message.indexOf("code=")+6,message.length-17)&&(micApproval=!0,setTimeout(function(){$("#security").css("visibility","hidden"),$("#flash").css("visibility","hidden"),angular.element("#customTextCtrl").scope().Widget.isPrivateBrowser=!1,angular.element("#customTextCtrl").scope().WebRtcClient.MakeFlashCall()},1e3)),"Microphone.Muted"==message.substring(message.indexOf("code=")+6,message.length-17)&&(micApproval=!0,setTimeout(function(){$("#security").css("visibility","hidden"),$("#flash").css("visibility","hidden"),angular.element("#customTextCtrl").scope().WebRtcClient.cancelCall(),updateStatusCallFlash("deny"),setTimeout(2e3),angular.element("#customTextCtrl").scope().Widget.isDisplayPrivacy=!1,angular.element("#customTextCtrl").scope().Widget.isPrivateBrowser=!1;var $body=angular.element(document.body),$rootScope=$body.scope().$root;$rootScope.$$phase||$rootScope.$apply()},1e3)))}function embedFlash(callback){var flashvars={rtmp_url:"rtmp://sip3.bontact.com/phone"},params={allowScriptAccess:"always"};swfobject.embedSWF("http://widget-prd.bontact.com/angular-modules/custom-text/freeswitch.swf","flash","250","150","9.0.0","expressInstall.swf",flashvars,params,[]);var check=setInterval(function(){var flash=$("#flash");try{flash[0].showPrivacy(),swfobject.ua.ie?($("#flash").css("top","-500px"),$("#flash").css("left","-500px")):$("#flash").css("visibility","hidden"),clearInterval(check),callback(!0)}catch(e){console.log(e)}},100)}function makeCall(number,account,options){updateStatusCallFlash("Dial..."),$("#flash")[0].makeCall(number,account,options)}function onCallState(uuid,state){("HANGUP"==state||"ACTIVE"==state)&&updateStatusCallFlash(state)}function onDisplayUpdate(uuid,name,number){uuidGlobal=uuid,updateStatusCallFlash("talking")}function hangup(uuid){$("#flash")[0].hangup(uuid)}function updateStatusCallFlash(status){angular.element("#customTextCtrl").scope().WebRtcClient.FlashStatus(status)}var bontactWidgetModule=angular.module("bontactWidget",["ngSanitize","angular-md5"]).constant("_",window._).provider("logEnhancer",function(){this.loggingPattern="%s - %s: ",this.$get=function(){this.loggingPattern;return{enhanceAngularLog:function($log){function enhanceLogging(loggingFunc,context){return function(){var modifiedArguments=[].slice.call(arguments);modifiedArguments[0]=[moment().format("dddd h:mm:ss a")+"::["+context+"]> "]+modifiedArguments[0],loggingFunc.apply(null,modifiedArguments)}}$log.getInstance=function(context){return{log:enhanceLogging($log.log,context),info:enhanceLogging($log.info,context),warn:enhanceLogging($log.warn,context),debug:enhanceLogging($log.debug,context),error:enhanceLogging($log.error,context)}}}}}}).run(function($log,logEnhancer){logEnhancer.enhanceAngularLog($log)}),layoutLablesLang={};bontactWidgetModule.config(["$compileProvider",function($compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|skype):/)}]).controller("CustomTextCtrl",function($scope,$rootScope,$http,$log,_,ChatBontact,TakeOnTheGo,Widget,BonWebRtc,visitorSer){function convertArrayToJson(textLabels){var tmpArray=[],layoutLables=_.select(textLabels,function(c){return"layout"===c.groupName&&0===c.isSystemMessage}),chatLables=_.select(textLabels,function(c){return"chat"===c.groupName&&0===c.isSystemMessage}),chatSystemLables=_.select(textLabels,function(c){return"chat"===c.groupName&&1===c.isSystemMessage}),callLables=_.select(textLabels,function(c){return"call"===c.groupName&&0===c.isSystemMessage}),callSystemLables=_.select(textLabels,function(c){return"call"===c.groupName&&1===c.isSystemMessage}),smsLables=_.select(textLabels,function(c){return"sms"===c.groupName&&0===c.isSystemMessage}),smsSystemLables=_.select(textLabels,function(c){return"sms"===c.groupName&&1===c.isSystemMessage}),emailLables=_.select(textLabels,function(c){return"email"===c.groupName&&0===c.isSystemMessage}),emailSystemLables=_.select(textLabels,function(c){return"email"===c.groupName&&1===c.isSystemMessage}),whatsAppLables=_.select(textLabels,function(c){return"whatsApp"===c.groupName&&0===c.isSystemMessage}),whatsAppSystemLables=_.select(textLabels,function(c){return"whatsApp"===c.groupName&&1===c.isSystemMessage}),generalSystemLables=_.select(textLabels,function(c){return"general"===c.groupName});_.forEach(layoutLables,function(n){tmpArray[n.labelName]=n.text}),$scope.layoutLabels=tmpArray,tmpArray=[],_.forEach(chatLables,function(n){tmpArray[n.labelName]=n.text}),$scope.chatLables=tmpArray,tmpArray=[],_.forEach(chatSystemLables,function(n){tmpArray[n.labelName]=n.text}),$scope.chatSystemLables=tmpArray,tmpArray=[],_.forEach(callLables,function(n){tmpArray[n.labelName]=n.text}),$scope.callLables=tmpArray,tmpArray=[],_.forEach(callSystemLables,function(n){tmpArray[n.labelName]=n.text}),$scope.callSystemLables=tmpArray,tmpArray=[],_.forEach(smsLables,function(n){tmpArray[n.labelName]=n.text}),$scope.smsLables=tmpArray,tmpArray=[],_.forEach(smsSystemLables,function(n){tmpArray[n.labelName]=n.text}),$scope.smsSystemLables=tmpArray,tmpArray=[],_.forEach(emailLables,function(n){tmpArray[n.labelName]=n.text}),$scope.emailLables=tmpArray,tmpArray=[],_.forEach(emailSystemLables,function(n){tmpArray[n.labelName]=n.text}),$scope.emailSystemLables=tmpArray,tmpArray=[],_.forEach(whatsAppLables,function(n){tmpArray[n.labelName]=n.text}),$scope.whatsAppLables=tmpArray,tmpArray=[],_.forEach(whatsAppSystemLables,function(n){tmpArray[n.labelName]=n.text}),$scope.whatsAppSystemLables=tmpArray,tmpArray=[],_.forEach(generalSystemLables,function(n){tmpArray[n.labelName]=n.text}),$scope.generalSystemLables=tmpArray,tmpArray=[],$scope.branding&&$scope.statusBranding($scope.branding);try{("editor"==parent.Wix.Utils.getViewMode()||"preview"==parent.Wix.Utils.getViewMode())&&($scope.layoutLabels.maximizedBontact="",$scope.layoutLabels.minimizedBontact="")}catch(e){}$scope.$apply()}$scope.automaticConnectEmail=function(){visitorSer.connectManual()},-1==window.location.protocol.indexOf("https"),$scope.isWixPopUp=-1!=window.location.href.indexOf("instance=")&&globalWidgetSettings.mobilepopup,$scope.facebookAccount="bontact",$scope.visitorObj=visitorSer.visitorObj,$scope.callback={},$scope.Facebooklogin=function(){Facebook.login(function(response){console.log(response)})},$scope.getLoginStatus=function(){Facebook.getLoginStatus(function(response){"connected"===response.status?$scope.loggedIn=!0:$scope.loggedIn=!1})},$scope.me=function(){Facebook.api("/me",function(response){$scope.user=response,console.log(response)})},$log=$log.getInstance("CustomTextCtrl"),$scope._=_,$scope.init=function(data){console.log("data.settings.textsLanguage"),console.log(data.settings.textsLanguage),$scope.Chat=new ChatBontact(data.settings.agents),$scope.TakeOnTheGo=new TakeOnTheGo,$scope.Widget=new Widget(data),$scope.Chat.connect(data.SurferObjGUI),$scope.WebRtcClient=new BonWebRtc,$scope.isWixPopUp=-1!=window.location.href.indexOf("instance=")&&globalWidgetSettings.mobilepopup,convertArrayToJson(data.settings.textsLanguage),visitorSer.loadSettings(),setTimeout(function(){},1e3)},$scope.fbLogin=function(){return!1},$scope.layoutLabels={},$scope.chatLables={},$scope.chatSystemLables={},$scope.callLables={},$scope.callSystemLables={},$scope.smsLables={},$scope.smsSystemLables={},$scope.emailLables={},$scope.emailSystemLables={},$scope.whatsAppLables={},$scope.whatsAppSystemLables={},$scope.generalSystemLables={},$scope.changeStatus=function(status){console.log(status);try{$scope.Chat.UpdateStatus(status)}catch(e){}},$scope.UpdateVisitorDetails=function(){$scope.Chat.UpdateVisitorDetails()},$scope.statusBranding=function(status){$scope.branding=status,1==status?($scope.layoutLabels.maximizedBontact="",$scope.layoutLabels.minimizedBontact=""):2==status&&($scope.layoutLabels.maximizedBontact="powered by bontact"),$scope.Widget&&$scope.Widget.SetutmLink()},$scope.statusProductPackage=function(data){$scope.skypePackage=data.skype,$scope.facebookPackage=data.facebook,$scope.webrtcPackage=data.webrtc},$scope.DisconnectChat=function(callback){$scope.Chat.disconnect(),callback&&callback()},$scope.ReconnectChat=function(){$scope.Chat.reconnect()},$scope.updateVisitorObj=function(visitor){visitorSer.autoconnect(visitor),$scope.visitorObj=visitorSer.visitorObj,$rootScope.$$phase||$rootScope.$apply()}}).filter("capitalize",function(){return function(input){return input?input.charAt(0).toUpperCase()+input.substr(1).toLowerCase():""}}).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown",function(event){var isOK=void 0!=this.value&&""!=this.value.trim();isOK&&(13!=event.keyCode&&9!=event.keyCode||event.shiftKey||(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())),scope.$apply()})}});var micApproval=!1,uuidGlobal,thisVisitorObj;bontactWidgetModule.factory("visitorSer",function($rootScope,$http,md5){function loadSettings(){if("undefined"==typeof window.localStorage._visitorObj||null==window.localStorage._visitorObj)defaultObject();else{var _visitorObjTemp=JSON.parse(window.localStorage._visitorObj);void 0!=_visitorObjTemp.id_Customer&&_visitorObjTemp.id_Customer==globalWidgetSettings.data.SurferObjGUI.id_Customer?(_visitorObj.id_Customer=_visitorObjTemp.id_Customer,_visitorObj.contact_id=_visitorObjTemp.contact_id,_visitorObj.name=_visitorObjTemp.name,_visitorObj.email=_visitorObjTemp.email,_visitorObj.telephone=_visitorObjTemp.telephone,_visitorObj.connected=_visitorObjTemp.connected,_visitorObj.loginnow=_visitorObjTemp.loginnow,_visitorObj.defaultName=_visitorObjTemp.defaultName,_visitorObj.tempicon=_visitorObjTemp.icon||_visitorObjTemp.tempicon):defaultObject()}}function defaultObject(){_visitorObj.name=void 0,_visitorObj.contact_id=void 0,_visitorObj.email=void 0,_visitorObj.telephone=void 0,_visitorObj.connected=!1,_visitorObj.loginnow=!1,_visitorObj.defaultName="Visitor",_visitorObj.tempicon="https://www.gravatar.com/avatar/"+md5.createHash("")+"?d=mm"}function tryConnectManual(){_visitorObj.connected||(_visitorObj.loginnow=!0)}function autoconnect(visitorData){_visitorObj.id_Customer=visitorData.id_Customer,_visitorObj.connected=visitorData.connected,_visitorObj.email=visitorData.email,_visitorObj.loginType=visitorData.loginType,_visitorObj.name=visitorData.name,_visitorObj.tempicon=visitorData.tempicon,_visitorObj.icon=visitorData.icon,_visitorObj.contact_id=visitorData.contact_id}function connectManual(){var re=/^[_a-z0-9]+(\.[_a-z0-9]+)*@[a-z0-9-]/,form=(re.test(_visitorObj.email),$(".profile_visitor").eq(0));if($.each($(".profile_visitor"),function(index,value){$(value).parsley().validate()}),form.parsley().validate(),!form.parsley().isValid())return!1;if(_visitorObj.email){_visitorObj.connected=!0,_visitorObj.t_icon="https://www.gravatar.com/avatar/"+md5.createHash(_visitorObj.email)+"?d=null",_visitorObj.loginType="manual",_visitorObj.loginnow=!1,_visitorObj.id_Customer=globalWidgetSettings.data.SurferObjGUI.id_Customer;try{$http.get(_visitorObj.t_icon).success(function(res){_visitorObj.tempicon=void 0,_visitorObj.icon=_visitorObj.t_icon}).error(function(err){_visitorObj.tempicon="https://www.gravatar.com/avatar/"+md5.createHash(_visitorObj.email)+"?d=mm",_visitorObj.icon=void 0})["finally"](function(){_visitorObj.t_icon=void 0,$rootScope.$$phase||$rootScope.$apply(),getContactID(function(id){_visitorObj.contact_id=id,saveLocal()})})}catch(e){}}else console.log("email required!"),_visitorObj.loginnow=!1,_visitorObj.email=void 0}function Disconnect(){_visitorObj.name="",_visitorObj.email="",_visitorObj.phone="",_visitorObj.connected=!1,_visitorObj.contact_id=void 0,_visitorObj.icon=void 0,_visitorObj.tempicon="https://www.gravatar.com/avatar/"+md5.createHash("")+"?d=mm",_visitorObj.loginnow=!1,window.localStorage.removeItem("_visitorObj"),createNewConversation(),$rootScope.$$phase||$rootScope.$apply()}function createNewConversation(){(0!=SurferObjGUI.id_Surfer||""!=SurferObjGUI.id_Surfer)&&(SurferObjGUI.id_Surfer=Math.floor(999e6*Math.random())+1e6,SurferObjGUI.idSurfer=SurferObjGUI.id_Surfer,setCookie("sur",SurferObjGUI.id_Surfer,10),angular.element("#customTextCtrl").scope().DisconnectChat(function(){angular.element("#customTextCtrl").scope().ReconnectChat()}))}function saveLocal(){window.localStorage._visitorObj=JSON.stringify(_visitorObj)}function LoginByFacebook(){fopener=window.open(globalWidgetSettings.serverWebSocket+"/auth/start/facebook?idCustomer="+SurferObjGUI.id_Customer+"&idSurfer="+SurferObjGUI.id_Surfer,"_blank","width=500 height=500")}function LoginByGoogle(){fopener=window.open(globalWidgetSettings.serverWebSocket+"/auth/start/google?idCustomer="+SurferObjGUI.id_Customer+"&idSurfer="+SurferObjGUI.id_Surfer,"_blank","width=500 height=500")}function LoginByTwitter(){fopener=window.open(globalWidgetSettings.serverWebSocket+"/auth/start/twitter?idCustomer="+SurferObjGUI.id_Customer+"&idSurfer="+SurferObjGUI.id_Surfer,"_blank","width=500 height=500")}function callbackSocialLogin(user,type){_visitorObj.email=user.emails?user.emails[0].value:"",_visitorObj.name=user.displayName,"default"!=user.photos[0].type&&(_visitorObj.icon=user.photos[0].value,_visitorObj.tempicon=void 0),_visitorObj.loginType=type,_visitorObj.connected=!0,_visitorObj.loginnow=!1,_visitorObj.id_Customer=globalWidgetSettings.data.SurferObjGUI.id_Customer,$rootScope.$$phase||$rootScope.$apply(),getContactID(function(id){_visitorObj.contact_id=id,saveLocal()})}function getContactID(callback){var dataPost={idCustomer:SurferObjGUI.id_Customer,idSurfer:SurferObjGUI.id_Surfer,visitor:_visitorObj},url=globalWidgetSettings.serverBaseApiUrl+"getContactId";ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){var id=data.data.contact_id;id&&""!=id&&callback(id)})}var _visitorObj={};return{visitorObj:_visitorObj,callbackSocialLogin:callbackSocialLogin,tryConnectManual:tryConnectManual,connectManual:connectManual,Disconnect:Disconnect,LoginByFacebook:LoginByFacebook,LoginByGoogle:LoginByGoogle,LoginByTwitter:LoginByTwitter,update:saveLocal,autoconnect:autoconnect,loadSettings:loadSettings,createNewConversation:createNewConversation}}),bontactWidgetModule.directive("visitorProfile",function(){return{restrict:"EA",replace:!0,scope:{generalLables:"=",channel:"@",channeltype:"@",stateover:"@"},link:function(scope,element,attrs){},controller:function($scope,$http,md5,visitorSer){$scope.visitor=visitorSer.visitorObj,console.log("$scope.generalLables"),console.log($scope.generalLables),console.log("visitorSer.visitorObj"),console.log(visitorSer.visitorObj),$scope.trylogin=function(){visitorSer.tryConnectManual()},$scope.connect=function(){visitorSer.connectManual()},$scope.disconnect=function(){visitorSer.Disconnect()},$scope.LoginByFacebook=function(){visitorSer.LoginByFacebook()},$scope.LoginByGoogle=function(){visitorSer.LoginByGoogle()},$scope.LoginByTwitter=function(){visitorSer.LoginByTwitter()},$scope.isChatChannel="chat"==$scope.channeltype},template:'<div class="visitorProfile"><div  ng-hide="visitor.connected||(visitor.loginnow||stateover)" class="visitor-single-input"><div style="min-height: 18px;">{{channel}}</div><input type="text" placeholder="{{generalLables.email}} *,{{generalLables.name}}" ng-click="trylogin()"><div class="visitor-social" ><i class="fa fa-facebook-official" style="font-size:20px" ng-click="LoginByFacebook()"></i><i id="logingoogle" class="fa fa-google-plus-square" style="font-size:20px" ng-click="LoginByGoogle()"></i></div></div><div class="profile_visitor visitor-double-input" data-parsley-validate ng-show="(visitor.loginnow||stateover)" ><div  ng-show="visitor.connected"><div>you are connected as {{visitor.name||visitor.email}}</div></div><input placeholder="{{generalLables.email}} *" type="email" ng-disabled="visitor.connected" required   ng-model="visitor.email"   ng-pattern="/^[_a-z0-9]+(\\.[_a-z0-9]+)*@[a-z0-9-]+(\\.[a-z0-9-]+)*(\\.[a-z]{2,4})$/"  data-parsley-type="email" data-parsley-trigger="blur" data-parsley-required data-parsley-mincheck="2" data-parsley-length="[5, 254]" data-parsley-required-message="{{emailSystemLables.emptyMsgLabel}}" data-parsley-type-message="{{emailSystemLables.invalidEmailLabel}}" data-parsley-length-message="{{emailSystemLables.invalidEmailLabel}}"><input placeholder="{{generalLables.name}}" maxlength="30" ng-disabled="visitor.connected" type="text" ng-model="visitor.name"><input placeholder="{{generalLables.phone}}" ng-show="stateover"  maxlength="30" type="text" ng-model="visitor.telephone" ><div class="visitor-social" ng-hide="visitor.connected"><div><button ng-show="{{stateover}}" class="chatbox-form-btn" ng-class="{\'disabled-btn\':!visitor.email}" ng-click="connect()">Sign in</button></div><p >{{generalLables.orConnectBy}}</p><i class="fa fa-facebook-official" style="font-size:20px" ng-click="LoginByFacebook()"></i><i class="fa fa-google-plus-square" style="font-size:20px" ng-click="LoginByGoogle()"></i></div><div ng-show="visitor.connected"><button class="chatbox-form-btn" ng-click="disconnect(); $event.stopPropagation();">{{generalLables.disconnect}}</button> </div></div></div>'}}),bontactWidgetModule.factory("ActionChannels",function($rootScope,$http){var ActionChannel=function(){this.ddd={}};return ActionChannel.prototype.send=function(){alert("ok")},ActionChannel}).factory("ChatBontact",function($rootScope,$http,$filter,visitorSer){function loadOldConversationVisitor(surferID,callback){if(""==surferID&&(surferID=getCookie("sur")),""!=surferID){var urlRes=String.format(globalWidgetSettings.serverBaseApiUrl+"getconversationDataSurfer/{0}/{1}",globalWidgetSettings.bontactId,surferID);console.log("loadOldConversationVisitor: "+urlRes),ajaxRequest(urlRes,function(data){console.log("loadOldConversationVisitor result:"),callback(data)})}}var Chat=function(data){this.preChat={Msg:"",email:globalWidgetSettings.email?globalWidgetSettings.email:"",name:globalWidgetSettings.name?globalWidgetSettings.name:""},this.inputChat="",this.ChatData=[],this.SurferObj={},this.StartTimerRepAnswerd=!1,this.repAnswerd=void 0,this.agenttyping=!1,this.waitingNewMsg=!1,this.isMobileDevice="mobile"==$.ua.device.type,this.isMobileDevice||(this.isMobileDevice="tablet"==$.ua.device.type&&(window.screen.width<400||window.screen.height<400)),this.waitingNewMsg=readCookie("waitingNewMsg")?"true"==readCookie("waitingNewMsg"):!1,this.agents=data},listenSocket=!1;Chat.prototype.UpdateVisitorDetails=function(){""!=this.preChat.name&&writeCookie("preChatname",this.preChat.name),""!=this.preChat.email&&writeCookie("preChatemail",this.preChat.email)},Chat.prototype.connect=function(SurferObjGUI){console.log("connect................"),void 0!==readCookie("preChatname")&&(this.preChat.name=readCookie("preChatname")),void 0!==readCookie("preChatemail")&&(this.preChat.email=readCookie("preChatemail"));SurferObjGUI&&(this.SurferObj=SurferObjGUI);var url=globalWidgetSettings.serverWebSocket;try{void 0!==socketio&&socketio.connected||(socketio=io.connect(url))}catch(e){console.log("lost socket connection",e)}listenSocket||this.ListenSocket()},Chat.prototype.disconnect=function(){this.ChatData=[],socketio.disconnect()},Chat.prototype.reconnect=function(){console.log("reconnect socket"),socketio.connect()},Chat.prototype.ListenSocket=function(){listenSocket=!0;var thisObj=this;try{if(parent.Wix&&("editor"==parent.Wix.Utils.getViewMode()||"preview"==parent.Wix.Utils.getViewMode()))return}catch(e){}socketio.on("connect",function(){thisObj.SurferObj.name_Representive="",repGender=!0,privatePicture=!1;(null===thisObj.SurferObj.statusType||""===thisObj.SurferObj.statusType)&&(thisObj.SurferObj.statusType=STATUS_SURFER.Waiting.value),console.log("startAndConnect::SurferObj.id_Customer: "+thisObj.SurferObj.id_Customer),void 0!==globalWidgetSettings.pageTitle&&(thisObj.SurferObj.title=globalWidgetSettings.pageTitle),void 0!==globalWidgetSettings.pageUrl&&addPageSurfer(thisObj.SurferObj,globalWidgetSettings.pageUrl),console.log(thisObj.SurferObj),socketio.emit("visitorConnected",{idCustomer:thisObj.SurferObj.id_Customer,surfer:thisObj.SurferObj},function(callback){console.log("visitorConnected-callback:"),console.log(callback)})}),socketio.on("pushMessageChat",function(data){globalWidgetSettings.data.settings.widget.chat_active||(globalWidgetSettings.data.settings.widget.chat_active=!0,setChannel("chat",!0),selectedType("chat")),thisObj.repAnswerd=!0,console.log("pushMessageChat..."),data.messageObj.idRep=data.messageObj.id_Representive,data.messageObj.txt=sanitizeHtml(data.messageObj.txt),data.messageObj.avatarAgent=thisObj.GetAvatarAgent(data.messageObj.idRep,data.messageObj.agentReply),thisObj.ChatData.push(data.messageObj),thisObj.waitingNewMsg=!0,thisObj.SurferObj.statusType==STATUS_SURFER.CHAT.value&&thisObj.ActiveChannel!=STATUS_SURFER.Waiting&&(thisObj.waitingNewMsg=!1,console.log(thisObj.SurferObj),socketio.emit("visitorRead",thisObj.SurferObj)),isMobileDevice||thisObj.SurferObj.statusType!=STATUS_SURFER.Waiting.value||selectedType("chat"),writeCookie("waitingNewMsg",thisObj.waitingNewMsg),$rootScope.$apply(),visitorSer.visitorObj.connected||(visitorSer.visitorObj.tempConnected=!0,$rootScope.visitorObj&&($rootScope.visitorObj.tempConnected=!0),$rootScope.$$phase||$rootScope.$apply()),setTimeout(function(){$("#chatFeedWrapper").animate({scrollTop:$("#widgetInner").height()},200)},300),$("#sound1").attr("src",globalWidgetSettings.soundUrl)}),socketio.on("disconnect",function(){console.log("socket disconnect")}),socketio.on("reconnect",function(){console.log("socket reconnect")}),socketio.on("repwriting",function(mode){thisObj.agenttyping=mode,$rootScope.$apply()}),socketio.on("invite",function(data){console.log(data),thisObj.repAnswerd=!0,globalWidgetSettings.data.settings.widget.chat_active||(globalWidgetSettings.data.settings.widget.chat_active=!0,setChannel("chat",!0)),data.txt.avatarAgent=thisObj.GetAvatarAgent(data.txt.id_Representive,data.txt.agentReply),thisObj.ChatData.push(data.txt),thisObj.waitingNewMsg=!0,isMobileDevice||selectedType("chat"),$rootScope.$apply(),visitorSer.visitorObj.connected||(visitorSer.visitorObj.tempConnected=!0,$rootScope.visitorObj?$rootScope.visitorObj.tempConnected=!0:$rootScope.visitorObj=visitorSer.visitorObj,$rootScope.$$phase||$rootScope.$apply()),$("#sound1").attr("src",globalWidgetSettings.soundUrl),$("#chatFeedWrapper").animate({scrollTop:$("#widgetInner").height()},200)}),socketio.on("visitorRead",function(){thisObj.waitingNewMsg=!1,$rootScope.$apply()}),socketio.on("loginSocialSuccess",function(data){console.log("loginSocialSuccess"),console.log(data),fopener.close(),visitorSer.callbackSocialLogin(data.user,data.type)}),loadOldConversationVisitor(thisObj.SurferObj.idSurfer,function(result){for(var i=0;i<result.length;i++){var dataMes=result[i],msgRow={rep_Sur:dataMes.agentReply,systemMsg:dataMes.systemMsg,name:dataMes.name,txt:sanitizeHtml(dataMes.message),agentReply:dataMes.agentReply,id_Surfer:dataMes.idSurfer,id_Call:0,id_Customer:dataMes.idCustomer,idRep:dataMes.idRep,avatarAgent:thisObj.GetAvatarAgent(dataMes.idRep,dataMes.agentReply)};thisObj.ChatData.push(msgRow)}$rootScope.$apply(),result.length>0&&$("#chatFeedWrapper").animate({scrollTop:$("#widgetInner").height()},200)})},Chat.prototype.classMsg=function(data){return data.rep_Sur?"chatbox-messages-item-left":"chatbox-messages-item-right"},Chat.prototype.IconMsg=function(data){return data.rep_Sur?"agent-thumb":"visitor-thumb"},Chat.prototype.avatarIcon=function(data){return data.rep_Sur?"assets/images/agent-man.png":"assets/images/avatar.png"},Chat.prototype.startChat=function(){var thisObj=this;if(0!==$("#chat_wrapper .parsley-error").length)return!1;if(void 0!==this.preChat.Msg&&""!=this.preChat.Msg.trim()){this.StartTimerRepAnswerd||(this.StartTimerRepAnswerd=!0,this.SetNoOnline());var flag=!1;if(!visitorSer.visitorObj.connected&&visitorSer.visitorObj.email?(flag=!0,visitorSer.connectManual()):visitorSer.visitorObj.tempConnected=!0,!visitorSer.visitorObj.connected&&!visitorSer.visitorObj.tempConnected)return void alert("visitor not connected");""!=this.preChat.name&&writeCookie("preChatname",this.preChat.name),""!=this.preChat.email&&writeCookie("preChatemail",this.preChat.email),flag?setTimeout(function(){thisObj.emitstartChat(thisObj)},700):this.emitstartChat(this)}},Chat.prototype.emitstartChat=function(thisObj){var msgRow={rep_Sur:!1,systemMsg:!1,id_Representive:thisObj.SurferObj.id_Representive,name:visitorSer.visitorObj.name,txt:sanitizeHtml(thisObj.preChat.Msg),agentReply:!1,id_Surfer:thisObj.SurferObj.id_Surfer,id_Call:0,id_Customer:thisObj.SurferObj.id_Customer,avatarAgent:thisObj.GetAvatarAgent(null,!1),title:thisObj.SurferObj.title,page:globalWidgetSettings.pageUrl,browser:thisObj.SurferObj.browseType,ip:thisObj.SurferObj.ip};socketio.emit("startChat",{surfer:thisObj.SurferObj,preChat:visitorSer.visitorObj,messageObj:msgRow},function(callback){if(console.log("callback start-chat:"),console.log(callback),callback.status){if($("#prechat").addClass("hidden"),$("#chatOnline").removeClass("hidden"),$("#chatOnlineinner").removeClass("hidden"),$("#msg-box").removeClass("hidden"),globalWidgetSettings.packSettingsData.analytics_event)try{parent.pushEvent("chat","startChat")}catch(e){}thisObj.ChatData.push(msgRow),$rootScope.$apply()}})};var timer_typing;return Chat.prototype.typing=function(){var thisObj=this;console.log("typing"),clearTimeout(timer_typing),socketio.emit("Surfer_Writing",{surfer:thisObj.SurferObj,mode:!0}),timer_typing=setTimeout(function(){socketio.emit("Surfer_Writing",{surfer:thisObj.SurferObj,mode:!1})},600)},Chat.prototype.sendChatTxt=function(){if(void 0!==this.inputChat&&""!=this.inputChat.trim()){this.StartTimerRepAnswerd||(this.StartTimerRepAnswerd=!0,this.SetNoOnline());var thisObj=this,msgRow={rep_Sur:!1,systemMsg:!1,id_Representive:this.SurferObj.id_Representive,name:visitorSer.visitorObj.name,txt:sanitizeHtml(this.inputChat),agentReply:!1,id_Surfer:this.SurferObj.id_Surfer,id_Call:0,id_Customer:this.SurferObj.id_Customer,avatarAgent:thisObj.GetAvatarAgent(null,!1),email:visitorSer.visitorObj.email,icon:visitorSer.visitorObj.icon,browser:SurferObjGUI.browseType,page:globalWidgetSettings.pageUrl,title:globalWidgetSettings.pageTitle};socketio.emit("sendChatTxt",{surfer:thisObj.SurferObj,messageObj:msgRow,visitor:visitorSer.visitorObj},function(callback){console.log("callback start-chat:"),console.log(callback),callback.status&&(thisObj.inputChat="",thisObj.ChatData.push(msgRow),$rootScope.$apply(),$("#chatFeedWrapper").animate({scrollTop:$("#widgetInner").height()},200))})}},Chat.prototype.SetNoOnline=function(){var thisObj=this;setInterval(function(){void 0===thisObj.repAnswerd&&(thisObj.repAnswerd=!1,$rootScope.$apply(),$("#chatFeedWrapper").animate({scrollTop:$("#widgetInner").height()},200))},6e4)},Chat.prototype.UpdateStatus=function(status){this.SurferObj.statusType=status.value,this.ActiveChannel=status,"undefined"!=typeof socketio&&(socketio.emit("changeStatus",{surfer:this.SurferObj}),status==STATUS_SURFER.CHAT&&(this.waitingNewMsg=!1,writeCookie("waitingNewMsg",this.waitingNewMsg),$rootScope.$apply()))},Chat.prototype.ShowTxt=function(txt){return txt=stripScripts(txt),replaceURLWithHTMLLinks(txt)},Chat.prototype.GetAvatarAgent=function(idRep,fromAgent){if(fromAgent){if(void 0===idRep||null==idRep)return globalWidgetSettings.baseUrl+"assets/images/agent-man.png";var agent=$filter("filter")(this.agents,{idRep:idRep})[0];return agent?agent.img:globalWidgetSettings.baseUrl+"assets/images/agent.jpg"}return visitorSer.visitorObj.tempicon||visitorSer.visitorObj.icon},Chat}).factory("TakeOnTheGo",function($rootScope,$http,$filter,visitorSer){var TakeOnTheGo=function(){this.main=!1,this.msg=!1,this.inner={sms:!1,callme:!1,whatsapp:!1,mobileBrowser:!1,facebook:!1},this.widget=globalWidgetSettings.data.settings.widget,this.errMsg="",this.facebook={},this.widget.moreChannels||(this.widget.moreChannels={facebook:{active:!1},skype:{active:!1}}),globalWidgetSettings.OpenMorechannels&&(this.main=!0)};return TakeOnTheGo.prototype.allowSkype=function(){return this.widget.moreChannels&&this.widget.moreChannels.skype&&this.widget.moreChannels.skype.active},TakeOnTheGo.prototype.allow=function(){var isWixPopUp=-1!=window.location.href.indexOf("instance=")&&globalWidgetSettings.mobilepopup;return isWixPopUp?!1:this.widget.whatsapp_active||this.widget.sms_active||this.widget.callback_active||this.widget.mail_active||this.widget.chat_active},TakeOnTheGo.prototype.openMoreChannelsWindow=function(){selectedType("chat",!0),this.main=!0},TakeOnTheGo.prototype.closeMoreChannelsWindow=function(){this.main=!1},TakeOnTheGo.prototype.openWindow=function(){this.main?this.main=!1:this.main=!0},TakeOnTheGo.prototype.connectToFacebook=function(facebookUserLogin){var emailName_facebook,EmailAddress_facebook;emailName_facebook=facebookUserLogin.first_name+" "+facebookUserLogin.last_name,EmailAddress_facebook=facebookUserLogin.email;var url=globalWidgetSettings.serverBaseApiUrl+"actions",dataPost={type:"facebook",idCustomer:SurferObjGUI.id_Customer,idSurfer:SurferObjGUI.id_Surfer,email:EmailAddress_facebook,name:emailName_facebook,title:globalWidgetSettings.pageTitle,token:globalWidgetSettings.bontactId,google_analytics:{}};ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){try{console.log(data)}catch(e){console.log("btnCallMe:exception: "+e)}return data.status,!1},function(data,textStatus){return gaEvent("call-widgeterror"),!1}),this.facebook.pre=!1,this.facebook.show=!0,$rootScope.$$phase||$rootScope.$apply()},TakeOnTheGo.prototype.channelsScript=function(){window.fbAsyncInit=function(){FB.init({appId:"103813126681441",xfbml:!0,version:"v2.6",status:!0,cookie:!0,oauth:!0})},setTimeout(function(){!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5",fjs.parentNode.insertBefore(js,fjs))}(document,"script","facebook-jssdk")},1e3)},TakeOnTheGo.prototype.select=function(val){switch(this.inner.sms=!1,this.inner.callme=!1,this.inner.whatsapp=!1,this.inner.mobileBrowser=!1,this.inner.facebook=!1,this.inner.email=!1,val){case"sms":this.inner.sms=!0;break;case"callme":this.inner.callme=!0;break;case"whatsapp":this.inner.whatsapp=!0;break;case"mobileBrowser":this.inner.mobileBrowser=!0;break;case"email":this.inner.email=!0,this.main=!1,selectedType("email"),this.inner.email=!1;break;case"facebook":this.inner.facebook=!0,this.main=!1,selectedType("facebook"),
this.inner.facebook=!1,this.facebook.show=!1}},TakeOnTheGo.prototype.skypeLink=function(){return this.widget.moreChannels&&this.widget.moreChannels.skype?"skype:"+this.widget.moreChannels.skype.user+"?call":""},TakeOnTheGo.prototype.clickSkypeLink=function(){var u=!0;window.onblur=function(){u=!1,console.log("skype installed..")},setTimeout(function(){u&&alert("Please install Skype application in order to make this call")},2e3)},TakeOnTheGo.prototype.takeOnTheGoEnableBtn=function(){return this.inner.sms||this.inner.callme||this.inner.whatsapp||this.inner.mobileBrowser},TakeOnTheGo.prototype.Submit=function(e){var blockMessage,okMessage,thisObj=this;thisObj.onthegoWindow_error_msg=!1;var activeChannel=this.inner.sms?"sms":this.inner.callme?"callme":this.inner.whatsapp?"whatsapp":this.inner.mobileBrowser?"mobileBrowser":"",telInput=$(".tel_input_onthego").eq(0);if(telInput.intlTelInput("isValidNumber")){var url,areaCode=telInput.intlTelInput("getSelectedCountryData").dialCode,target=telInput.intlTelInput("getNumber").replace("+","").slice(areaCode.length),content="The visitor needed to step away and would like to continue on "+("mobileBrowser"==activeChannel?"his mobile device":activeChannel)+". You can continue communicating with him right here.",lastPage="string"==typeof SurferObjGUI.page?SurferObjGUI.page:SurferObjGUI.page[SurferObjGUI.page.length-1];switch(activeChannel){case"callme":url=String.format(globalWidgetSettings.serverBaseApiUrl+"action/callme/{0}/{1}/{2}?idSurfer={3}&page={4}",SurferObjGUI.id_Customer,areaCode,target,SurferObjGUI.id_Surfer,encodeURIComponent(lastPage)),blockMessage=getSystemMessageText("call","requestLabel"),okMessage=getSystemMessageText("call","nowLabel");break;case"sms":url=String.format(globalWidgetSettings.serverBaseApiUrl+"action/sms/{0}/{1}/{2}?idSurfer={3}&page={4}&content={5}",SurferObjGUI.id_Customer,areaCode,target,SurferObjGUI.id_Surfer,encodeURIComponent(lastPage),encodeURIComponent(content)),void 0!==globalWidgetSettings.pageTitle&&(url=String.format(url+"&title={0}",globalWidgetSettings.pageTitle)),blockMessage=getSystemMessageText("sms","requestLabel"),okMessage=getSystemMessageText("sms","sentLabel");break;case"whatsapp":url=String.format(globalWidgetSettings.serverBaseApiUrl+"action/whatsapp/{0}/{1}/{2}?idSurfer={3}&page={4}&content={5}",SurferObjGUI.id_Customer,0,areaCode.toString()+target.toString(),SurferObjGUI.id_Surfer,encodeURIComponent(lastPage),encodeURIComponent(content)),void 0!==globalWidgetSettings.pageTitle&&(url=String.format(url+"&title={0}",globalWidgetSettings.pageTitle)),blockMessage=getSystemMessageText("email","requestLabel"),okMessage=getSystemMessageText("sms","sentLabel");break;case"mobileBrowser":url=String.format(globalWidgetSettings.serverBaseApiUrl+"action/sms/{0}/{1}/{2}?idSurfer={3}&page={4}&content={5}",SurferObjGUI.id_Customer,areaCode,target,SurferObjGUI.id_Surfer,encodeURIComponent(lastPage),encodeURIComponent(content)),void 0!==globalWidgetSettings.pageTitle&&(url=String.format(url+"&title={0}",globalWidgetSettings.pageTitle));var data={bontactId:globalWidgetSettings.bontactId,selectChannel:"chat",idSurfer:SurferObjGUI.idSurfer,mobilepopup:!0,visitorObj:visitorSer.visitorObj};void 0!==readCookie("preChatname")&&(data.name=readCookie("preChatname")),void 0!==readCookie("preChatemail")&&(data.email=readCookie("preChatemail")),url+="&datachat="+window.btoa(encodeURI(JSON.stringify(data))),blockMessage=getSystemMessageText("sms","requestLabel"),okMessage=getSystemMessageText("sms","sentLabel")}url+="&systemmsg=true",$("#blockMsg").remove();var BlockM='<p id="blockMsg" class="blockUiMsg">'+blockMessage+'</p><a id="btnCancelUnblock" onclick="return unblockAll()" class="userMsg cancel hidden" href="#">'+getSystemMessageText("call","closeButton")+"</a>";void 0!==url&&($("#"+e+"_wrapper").block({message:BlockM,overlayCSS:{backgroundColor:"rgba(0,0,0,1)"}}),$("#btnCancelCall").removeClass("hidden"),console.log(url),$http.get(url).success(function(response){console.log("response--->"),console.log(response),response.result&&response.result.status||response.status?(thisObj.main=!1,thisObj.errMsg="",$("#blockMsg").text(okMessage)):$("#blockMsg").text(response.message?response.message:"An error has occurred"),setTimeout(function(){$("#chat_wrapper").unblock()},5e3)}).error(function(err){console.log("error sendWhatsAppMessage"),console.log(err),thisObj.errMsg=err,$("#chat_wrapper").unblock()}))}else thisObj.onthegoWindow_error_msg=!0,$("#onthegoWindow-error-msg").removeClass("hidden")},TakeOnTheGo}).factory("Widget",function($rootScope,$http,$filter,visitorSer){function updateIdContact(id){""!=id&&void 0!=id&&null!=id&&(visitorSer.visitorObj.contact_id=id,visitorSer.update())}var Widget=function(data){this.data=data,this.utmLink="?",this.allowWebRtc=DetectRTC.hasMicrophone&&DetectRTC.isWebRTCSupported&&"Edge"!=$.ua.browser.name,console.log("DetectRTC.hasMicrophone:",DetectRTC.hasMicrophone);var isWixPopUp=-1!=window.location.href.indexOf("instance=");isWixPopUp&&(this.allowWebRtc=!1),this.allowWebRtcWithNoSSLDomain=!1,this.allowWebRtc&&-1==window.location.protocol.indexOf("https")&&(this.allowWebRtcWithNoSSLDomain=!0),this.allowWebRtc||console.log("WEBRTC NOT SUPPORTED");var hasCorrectVersion=(globalWidgetSettings.data.SurferObjGUI.id_Customer,swfobject.hasFlashPlayerVersion("9.0.18"));this.allowFlash=!this.allowWebRtcWithNoSSLDomain&&!this.allowWebRtc&&DetectRTC.hasMicrophone&&hasCorrectVersion&&"IE"!==$.ua.browser.name,this.isPrivateBrowser=!1,this.isDisplayPrivacy=!1,console.log("allowWebRtc:",this.allowWebRtc),console.log("allowFlash:",this.allowFlash),console.log("allowWebRtcWithNoSSLDomain:",this.allowWebRtcWithNoSSLDomain);var isWixPopUp=-1!=window.location.href.indexOf("instance=");isWixPopUp&&(this.allowWebRtc=!1,this.allowFlash=!1)};return Widget.prototype.SetutmLink=function(){this.utmLink="?utm_source="+globalWidgetSettings.data.SurferObjGUI.id_Customer+"&utm_medium=widget_link&utm_term="+globalWidgetSettings.pageUrl+"&utm_campaign=link_"+(1==globalWidgetSettings.packSettingsData.branding?"premium":"free")},Widget.prototype.callbackSubmitDisabled=function(){var telInput=$("#tel_input_callback");return $(telInput).val().length<10||!/^\d+$/.test(telInput.val().substring(1))?!0:!telInput.intlTelInput("isValidNumber")},Widget.prototype.smsSubmitDisabled=function(){var telInput=$("#tel_input_sms");return $(telInput).val().length<10||!/^\d+$/.test(telInput.val().substring(1))?!0:$("#txtSmsContent").val().trim().length<1?!0:!telInput.intlTelInput("isValidNumber")},Widget.prototype.emailSubmitDisabled=function(){var form=$("#frmSendEmail");return form.parsley().validate(),form.parsley().isValid()?!1:!0},Widget.prototype.submitCall=function(){try{var form=$("#frmCallback"),telInput=$("#tel_input_callback"),errorMsg=$("#call-error-msg");if(errorMsg.hasClass("hidden")===!1&&errorMsg.addClass("hidden"),form.parsley().validate(),form.parsley().isValid()&&telInput.intlTelInput("isValidNumber")){console.log("btnCallMe::click start");var areaCode=telInput.intlTelInput("getSelectedCountryData").dialCode,target=telInput.intlTelInput("getNumber").replace("+","").slice(areaCode.length);visitorSer.update(),console.log("phone number(target): "+target),setTimeout(function(){$("#callback_wrapper").block({message:'<p id="callTextMsg" class="blockUiMsg">'+getSystemMessageText("call","requestLabel")+'</p><a id="btnCancelCall" onclick="return cancelCall()" class="userMsg cancel hidden" href="#">'+getSystemMessageText("call","closeButton")+"</a>",overlayCSS:{backgroundColor:"rgba(0,0,0,0.8)"},css:{top:"10%",width:"60%",left:"20%"}})},100),$("#btnCancelCall").removeClass("hidden");var url=globalWidgetSettings.serverBaseApiUrl+"actions",dataPost={type:"callme",idCustomer:SurferObjGUI.id_Customer,target:areaCode+""+target,idSurfer:SurferObjGUI.id_Surfer,systemmsg:!1,title:globalWidgetSettings.pageTitle,token:globalWidgetSettings.bontactId,google_analytics:{},visitor:visitorSer.visitorObj};console.log("dataPost"),console.log(dataPost),globalWidgetSettings.mobilepopup||(dataPost.page="string"==typeof SurferObjGUI.page?SurferObjGUI.page:SurferObjGUI.page[SurferObjGUI.page.length-1]);try{dataPost.google_analytics={analyticsid:parent.AnalyticsClient.accountUA,analyticsvisitor:parent.AnalyticsClient.gaId}}catch(e){}showMsgCallStatus("error",""),ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){if(data.status){if(console.log(data),updateIdContact(data.contact_id),sentConversionBon("call-widgetsuccess"),gaEvent("call-widgetsuccess"),data.allow_event)try{parent.pushEvent("call",areaCode+target)}catch(e){}data.allow_conversion&&sentConversionBon("call"),setTimeout(function(){$("#callTextMsg").text(getSystemMessageText("call","nowLabel"))},8e3);try{parent.hiveContact({phone:areaCode+target})}catch(e){}}else{sentConversionBon("call-widgeterror"),gaEvent("call-widgeterror");var messageErr=getSystemMessageText("general","errorMsg"+data.code);showMsgCallStatus("error",messageErr)}return!1},function(data,textStatus){return gaEvent("call-widgeterror"),!1})}else telInput.intlTelInput("isValidNumber")||errorMsg.removeClass("hidden")}catch(e){return!1}finally{return!1}},Widget.prototype.submitSms=function(){var form=$("#frmSendSms"),telInput=$("#tel_input_sms"),errorMsg=$("#sms-error-msg");if(errorMsg.hasClass("hidden")===!1&&errorMsg.addClass("hidden"),form.parsley().validate(),telInput.attr("placeholder",""),console.log("submitSms: "+form.parsley().isValid()),form.parsley().isValid()&&telInput.intlTelInput("isValidNumber")){console.log("btnSendSms::click start");try{var urlRes,areaCode=telInput.intlTelInput("getSelectedCountryData").dialCode,target=telInput.intlTelInput("getNumber").replace("+","").slice(areaCode.length),content=$("#txtSmsContent").val();visitorSer.update(),$("#sms_wrapper").block({message:'<p id="smsTextMsg" class="blockUiMsg">'+getSystemMessageText("sms","requestLabel")+'</p><a id="btnCancelSms" onclick="return cancelSms()" class="userMsg cancel" href="#">'+getSystemMessageText("sms","closeButton")+"</a>",overlayCSS:{backgroundColor:"rgba(0,0,0,0.8)"}}),$("#btnCancelSms").removeClass("hidden");var url=globalWidgetSettings.serverBaseApiUrl+"actions",dataPost={type:"sms",idCustomer:SurferObjGUI.id_Customer,target:areaCode+""+target,idSurfer:SurferObjGUI.id_Surfer,content:encodeURIComponent(content),systemmsg:!1,google_analytics:{},visitor:visitorSer.visitorObj};globalWidgetSettings.mobilepopup||(dataPost.page="string"==typeof SurferObjGUI.page?SurferObjGUI.page:SurferObjGUI.page[SurferObjGUI.page.length-1]);try{urlRes+="&analyticsid="+parent.AnalyticsClient.accountUA+"&analyticsvisitor="+parent.AnalyticsClient.gaId,dataPost.google_analytics={analyticsid:parent.AnalyticsClient.accountUA,analyticsvisitor:parent.AnalyticsClient.gaId},console.log(urlRes)}catch(e){}showMsgSmsStatus("error",""),ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){if(data.status){try{console.log(data),updateIdContact(data.contact_id)}catch(e){console.log("btnSendSms:exception: "+e)}if(gaEvent("sms-widgetsuccess"),sentConversionBon("sms-widgetsuccess"),showMsgSmsStatus("success","sms send success"),data.allow_event)try{parent.pushEvent("sms",areaCode+target)}catch(e){}data.allow_conversion&&sentConversionBon("sms");try{parent.hiveContact({phone:areaCode+target})}catch(e){}}else gaEvent("sms-widgeterror"),sentConversionBon("sms-widgeterror"),showMsgSmsStatus("error",data.message);return!1},function(data,textStatus,jqXHR){return gaEvent("sms-widgeterror"),showMsgSmsStatus("error",getSystemMessageText("sms","errorSendSms")),!1})}catch(e){console.log("btnSendSms:exception: "+e)}finally{return console.log("btnSendSms:: click finished"),setTimeout(function(){$("#smsTextMsg").text(getSystemMessageText("sms","sentLabel"))},8e3),!1}}else telInput.intlTelInput("isValidNumber")||errorMsg.removeClass("hidden");return!1},Widget.prototype.submitEmail=function(){var form=$("#frmSendEmail");if(form.parsley().validate(),form.parsley().isValid())try{var urlRes,content=$("#inputmessage").val();if(void 0===content||""==content.trim())return!1;$("#email_wrapper").block({message:"<p class=blockUiMsg>"+getSystemMessageText("email","requestLabel")+'</p><a id="btnCancelEmail" onclick="return cancelEmail()" class="userMsg cancel" href="#">'+getSystemMessageText("email","closeButton")+"</a>",overlayCSS:{backgroundColor:"rgba(0,0,0,0.8)"}});var url=("string"==typeof SurferObjGUI.page?SurferObjGUI.page:SurferObjGUI.page[SurferObjGUI.page.length-1],globalWidgetSettings.serverBaseApiUrl+"actions"),dataPost={type:"email",idCustomer:SurferObjGUI.id_Customer,name:visitorSer.visitorObj.name,idSurfer:SurferObjGUI.id_Surfer,content:encodeURIComponent(content),systemmsg:!1,google_analytics:{},visitor:visitorSer.visitorObj};globalWidgetSettings.mobilepopup||(dataPost.page="string"==typeof SurferObjGUI.page?SurferObjGUI.page:SurferObjGUI.page[SurferObjGUI.page.length-1]);try{urlRes+="&analyticsid="+parent.AnalyticsClient.accountUA+"&analyticsvisitor="+parent.AnalyticsClient.gaId,dataPost.google_analytics={analyticsid:parent.AnalyticsClient.accountUA,analyticsvisitor:parent.AnalyticsClient.gaId},console.log(urlRes)}catch(e){}showMsgEmailStatus("error",""),ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){if(data.status){try{console.log(data),updateIdContact(data.contact_id)}catch(e){console.log("btnCallMe:exception: "+e)}if(setTimeout(function(){$("#email_inner").unblock()},5e3),gaEvent("email-widgetsuccess"),sentConversionBon("email-widgetsuccess"),data.allow_event)try{parent.pushEvent("email","M: "+target)}catch(e){console.log("btnCallMe:exception: "+e)}data.allow_conversion&&sentConversionBon("email");try{parent.hiveContact({email:email,name:name})}catch(e){}}else if(gaEvent("email-widgeterror"),sentConversionBon("email-widgeterror"),data.errcode&&504==data.errcode){var urlRes2="https://dev-api01-eus.azurewebsites.net/log/1?p="+encodeURIComponent(urlRes);ajaxRequest(urlRes2,function(data,textStatus,jqXHR){})}return!1},function(data,textStatus,jqXHR){return gaEvent("email-widgeterror"),showMsgEmailStatus("error",getSystemMessageText("general","errorMsg105")),$("#email_inner").unblock(),!1})}catch(e){console.log("btnSendEmail:exception: "+e)}finally{return console.log("btnSendEmail:: click finished"),!1}},Widget}).factory("BonWebRtc",function($rootScope,$http,visitorSer){var WebRtc=function(d){this.config={},this.sip,this.session={},this.status="",this.btnvalue="start",this.btnDisabled=!1,this.sipClient={},this.sessionstart=!1,this.paramForNoSSLDomain={}};return WebRtc.prototype.register=function(callback){var thisObj=this;thisObj.cancelled=!1,thisObj.sessionstart=!1,thisObj.allowCancelled=!1;var url=globalWidgetSettings.serverBaseApiUrl+"actions",id_Customer=void 0==SurferObjGUI?this.paramForNoSSLDomain.id_Customer:SurferObjGUI.id_Customer,idSurfer=void 0==SurferObjGUI?this.paramForNoSSLDomain.id_Surfer:SurferObjGUI.id_Surfer,dataPost={type:"webrtc",idCustomer:id_Customer,idSurfer:idSurfer,systemmsg:!1,google_analytics:{},visitor:visitorSer.visitorObj};visitorSer.update(),thisObj.status="checking...",this.btnvalue="checking...",this.btnDisabled=!0,setTimeout(function(){"checking..."==thisObj.status&&(thisObj.status="please wait...",thisObj.btnvalue="please wait...",thisObj.btnDisabled=!0,$rootScope.$$phase||$rootScope.$apply())},6e3),$rootScope.$$phase||$rootScope.$apply(),ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){console.log(data),thisObj.cancelled||(data.status?(thisObj.status="connecting...",thisObj.btnvalue="connecting...",thisObj.btnDisabled=!0,$rootScope.$$phase||$rootScope.$apply(),thisObj.config=data.config,thisObj.callId=data.callId,thisObj.sip=data.sipnumber,callback(!0)):(thisObj.status=data.message,thisObj.allowCancelled=!0,$rootScope.$$phase||$rootScope.$apply()))},function(error){callback(!1)})},WebRtc.prototype.Connect=function(){var thisObj=this;this.sipClient=new SIP.UA(this.config),this.sipClient.register();var options={media:{constraints:{audio:!0,video:!1},render:{remote:document.getElementById("remoteVideo"),local:document.getElementById("localVideo")}}};this.session=this.sipClient.invite(this.sip,options),this.sipClient.on("connected",function(){thisObj.status="Connected",thisObj.allowCancelled=!0,$rootScope.$$phase||$rootScope.$apply()}),this.sipClient.on("registered",function(){}),this.sipClient.on("unregistered",function(){}),this.sipClient.on("invite",function(session){thisObj.status="Dial...",$rootScope.$$phase||$rootScope.$apply()}),this.session.on("accepted",function(){thisObj.sessionstart=!1,thisObj.status="talking",$rootScope.$$phase||$rootScope.$apply()}),this.session.on("bye",function(){thisObj.status="Call ended",$rootScope.$$phase||$rootScope.$apply()})},WebRtc.prototype.ConnectWithFlash=function(){embedFlash(function(success){if(checkMic())updateStatusCallFlash("noMic");else{var flash=$("#flash"),security=$("#security"),widgetWidth=$("#widget-body").width(),callbackWrapperWidth=$("#callback_wrapper").width(),callbackWrapperHeight=$("#callback_wrapper").height(),callbackWrapperPos=$("#callback_wrapper").offset(),flashWidth=flash.width(),flashHeight=flash.height(),offsetLeft=(callbackWrapperWidth-flashWidth)/2+callbackWrapperPos.left,offsetTop=(callbackWrapperHeight-flashHeight)/2+callbackWrapperPos.top,offsetTop=callbackWrapperPos.top+100;console.log("onConnected:"),console.log("widgetWidth: "+widgetWidth),console.log("callbackWrapperWidth: "+callbackWrapperWidth),console.log("callbackWrapperHeight: "+callbackWrapperHeight),console.log("callbackWrapperPos: "),console.log(callbackWrapperPos),console.log("flashWidth: "+flashWidth),console.log("flashHeight: "+flashHeight),console.log("offsetLeft: "+offsetLeft),console.log("offsetTop: "+offsetTop),flash.css({top:offsetTop+"px",left:offsetLeft+"px","z-index":"1000",visibility:"visible",position:"absolute"}),angular.element("#customTextCtrl").scope().Widget.isDisplayPrivacy=!0,updateStatusCallFlash("flashMessage"),DetectRTC.browser.isPrivateBrowsing&&(angular.element("#customTextCtrl").scope().Widget.isPrivateBrowser=!0,updateStatusCallFlash("privateMessage"));var $body=angular.element(document.body),$rootScope=$body.scope().$root;$rootScope.$$phase||$rootScope.$apply(),security.css("display","inline"),setTimeout(function(){micApproval||(flash.css("display","none"),angular.element("#customTextCtrl").scope().Widget.isDisplayPrivacy=!1,updateStatusCallFlash("deny"))},5e4)}},4e3)},WebRtc.prototype.MakeFlashCall=function(){var thisObj=this;angular.element("#customTextCtrl").scope().Widget.isDisplayPrivacy=!1;var $body=angular.element(document.body),$rootScope=$body.scope().$root;$rootScope.$$phase||$rootScope.$apply(),makeCall(thisObj.sip,"",[])},WebRtc.prototype.close=function(webRtcWithNoSSL){this.status="",this.btnvalue="start",this.btnDisabled=!1,this.sessionstart||this.cancelCall(webRtcWithNoSSL),this.cancelled=!0,this.allowCancelled=!1;try{this.session.cancel()}catch(e){console.log(e)}try{this.session.terminate()}catch(e){console.log(e)}try{this.session.bye()}catch(e){console.log(e)}webRtcWithNoSSL&&window.close()},WebRtc.prototype.cancelCall=function(webRtcWithNoSSL){if(this.callId){var url=globalWidgetSettings.serverBaseApiUrl+"webrtc/cancel",dataPost={idCustomer:1==webRtcWithNoSSL?this.paramForNoSSLDomain.id_Customer:SurferObjGUI.id_Customer,idSurfer:1==webRtcWithNoSSL?this.paramForNoSSLDomain.id_Surfer:SurferObjGUI.id_Surfer,callId:this.callId};ajaxPostRequest(url,dataPost,function(data,textStatus,jqXHR){console.log(data)}),this.callId=void 0}},WebRtc.prototype.ClickDial=function(allowFlash,params){var thisObj=this;void 0!=params&&(this.paramForNoSSLDomain.id_Surfer=params.id_Surfer,this.paramForNoSSLDomain.id_Customer=params.id_Customer),status=!0,this.register(function(status){status?allowFlash?thisObj.ConnectWithFlash():thisObj.Connect():updateStatusCallFlash("error")})},WebRtc.prototype.OpenPopupForNoSSLDomain=function(){var params={bontactId:globalWidgetSettings.bontactId,id_Customer:SurferObjGUI.id_Customer,id_Surfer:SurferObjGUI.id_Surfer};window.open(globalWidgetSettings.baseUrl+"webRtcWithPopup.html?params="+window.btoa(JSON.stringify(params)),"newwindow",'height=450,width=350,left=800,top=300,titlebar="web call", menubar=no, resizable=no,location=no, directories=no, status=no')},WebRtc.prototype.EndDial=function(allowFlash){if(allowFlash)hangup(uuidGlobal);else try{this.session.bye(),this.session.cancel(),this.session.terminate()}catch(e){console.log(e)}},WebRtc.prototype.FlashStatus=function(status){switch(this.messagePrivate=!1,this.messageFlash=!1,status){case"talking":this.sessionstart=!1,this.status="talking";break;case"ACTIVE":this.status="Connected",this.allowCancelled=!0;break;case"HANGUP":this.allowCancelled=!0,this.status="Call ended";break;case"noMic":this.allowCancelled=!0,this.status="Microphone is not available",this.messagePrivate=!1,this.cancelCall();break;case"deny":this.status="You must allow access to the microphone in order to make phone calls",this.allowCancelled=!0,this.cancelCall();break;case"privateMessage":this.messagePrivate=!0;break;case"flashMessage":this.messageFlash=!0;break;case"error":this.allowCancelled=!0,this.status="Oops ... an error occurred ... please try later",this.messagePrivate=!1}$rootScope.$$phase||$rootScope.$apply()},WebRtc});